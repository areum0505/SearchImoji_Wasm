<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM 기반 이모지 검색기</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        input { width: 70%; padding: 10px; font-size: 16px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        #status { margin-top: 10px; color: blue; font-weight: bold; }
        #output { margin-top: 20px; background: #f4f4f4; padding: 15px; white-space: pre-wrap; border-radius: 5px; }
        .emoji-result { margin: 5px 0; font-size: 1.2em; }
    </style>
    
    <script>
        // WASM 로드 이벤트를 처리할 Module 객체를 정의합니다.
        window.Module = {
            onRuntimeInitialized: function() {
                // WASM이 완전히 로드된 후 실행됩니다. (3/3 단계)
                debugger;
                document.getElementById('status').innerText = "3/3. WASM 모듈 로딩 완료.";
                
                window.WASM_Module = window.Module;
                
                // C++ 함수 래핑 (ccall 대신 cwrap 사용)
                const searchEmojisWASM = window.WASM_Module.cwrap('search_emojis', 'number', ['number']);
                const freeResultMemoryWASM = window.WASM_Module.cwrap('free_result_memory', null, ['number']);
                
                if (window.checkReady) window.checkReady(); // 다른 비동기 작업 완료 확인

                // --- WASM 호출 클릭 이벤트 리스너 정의 ---
                document.getElementById('runBtn').addEventListener('click', async () => {
                    const text = document.getElementById('userInput').value.trim();
                    if (!text || !window.extractor) return;

                    document.getElementById('status').innerText = "1/2. 텍스트를 임베딩 벡터로 변환 중...";
                    document.getElementById('output').innerText = "";
                    
                    // BERT(Transformers.js) 실행
                    const output = await window.extractor(text, { pooling: 'mean', normalize: true });
                    const vector = output.data;
                    
                    document.getElementById('status').innerText = "2/2. WASM 모듈로 유사도 계산 요청 중...";
                    
                    const EMBEDDING_DIM = 768;
                    const vectorByteSize = EMBEDDING_DIM * 8; // double (8바이트)
                    let wasmPtr = 0;
                    let resultPtr = 0;
                    
                    try {
                        // WASM 메모리에 쿼리 벡터 복사
                        wasmPtr = window.WASM_Module._malloc(vectorByteSize); 
                        for (let i = 0; i < EMBEDDING_DIM; i++) {
                            window.WASM_Module.setValue(wasmPtr + i * 8, vector[i], 'double');
                        }

                        // WASM 함수 호출
                        resultPtr = searchEmojisWASM(wasmPtr); 
                        const resultJsonString = window.WASM_Module.UTF8ToString(resultPtr);

                        // 결과 처리 및 출력
                        const results = JSON.parse(resultJsonString);
                        let htmlOutput = `<h4>✅ 검색 결과 (WASM 계산)</h4>`;
                        results.forEach((item, index) => {
                            const meta = window.emojiMetadata[item.index];
                            if (meta) {
                                htmlOutput += `<div class="emoji-result">
                                    ${index + 1}. ${meta.character} ${meta.description} 
                                    <span style="color: #666;">[Score: ${item.score}]</span>
                                </div>`;
                            }
                        });
                        document.getElementById('output').innerHTML = htmlOutput;
                        document.getElementById('status').innerText = "검색 완료";

                    } catch (error) {
                        console.error("WASM 실행 또는 결과 처리 오류:", error);
                        document.getElementById('status').innerText = `WASM 실행 오류: ${error.message}`;
                    } finally {
                        // 메모리 정리
                        if (wasmPtr) window.WASM_Module._free(wasmPtr);
                        if (resultPtr) freeResultMemoryWASM(resultPtr); 
                    }
                });
            }
        };
    </script>
    
    <script src="./emoji_search.js"></script> 
</head>
<body>
    <h2>WASM 기반 이모지 검색기</h2>
    <p>텍스트 임베딩(Transformers.js) 후 WASM으로 유사도 계산을 수행합니다.</p>

    <div>
        <input type="text" id="userInput" placeholder="변환할 문장을 입력하세요...">
        <button id="runBtn" disabled>모듈 로딩 중...</button>
    </div>

    <div id="status">초기화 시작: 데이터 로딩 (1/3), 모델 로딩 (2/3)</div>
    <div id="output">결과가 여기에 표시됩니다.</div>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.14.0';
        env.allowLocalModels = false; 

        // 전역 상태 변수 설정
        window.emojiMetadata = [];
        window.extractor = null;

        const statusDiv = document.getElementById('status');
        const runBtn = document.getElementById('runBtn');
        const CSV_FILE_PATH = './emoji.csv';

        // --- [3] 모든 준비 완료 확인 함수 ---
        window.checkReady = function() {
            if (window.extractor && window.WASM_Module && window.emojiMetadata.length > 0) {
                statusDiv.innerText = `모든 모듈 로딩 완료! 이모지 ${window.emojiMetadata.length}개 검색 준비 완료.`;
                statusDiv.style.color = "green";
                runBtn.disabled = false;
                runBtn.innerText = "이모지 검색 실행";
            }
        }

        // --- [4] CSV 로드 함수 (1/3) ---
        async function loadEmojiMetadata(filepath) {
            statusDiv.innerText = "1/3. 이모지 메타데이터 로드 중...";
            try {
                const response = await fetch(filepath);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const csvText = await response.text();
                
                const lines = csvText.trim().split('\n');
                const data = lines.map(line => {
                    const parts = line.match(/(?:[^\s,"]+|"(?:\\.|[^"])*")+/g);
                    if (!parts || parts.length < 2) return null;
                    const character = parts[0].trim();
                    const description = parts[1].replace(/"/g, '').trim();
                    return { character, description };
                }).filter(item => item !== null);
                
                window.emojiMetadata = data;
                statusDiv.innerText = `1/3. 메타데이터 로드 완료 (${data.length}개).`;
            } catch (err) {
                statusDiv.innerText = `오류 발생 (1/3): CSV 로드 실패. 서버 실행 또는 파일 경로 확인. (${err.message})`;
                statusDiv.style.color = "red";
                throw err;
            }
        }

        // --- [5] Transformers.js 모델 로드 (2/3) ---
        async function loadTransformerModel() {
            statusDiv.innerText = "2/3. 임베딩 모델 로딩 중...";
            try {
                window.extractor = await pipeline('feature-extraction', 'Xenova/all-mpnet-base-v2');
                statusDiv.innerText = "2/3. 임베딩 모델 로딩 완료.";
            } catch (err) {
                statusDiv.innerText = `오류 발생 (2/3): Transformers 모델 로드 실패. 네트워크 연결 확인. (${err.message})`;
                statusDiv.style.color = "red";
                throw err;
            }
        }

        // --- 초기 로딩 시작 ---
        loadEmojiMetadata(CSV_FILE_PATH).then(window.checkReady).catch(() => {});
        loadTransformerModel().then(window.checkReady).catch(() => {});
    </script>
</body>
</html>