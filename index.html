<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM vs JavaScript 이모지 검색 성능 비교</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        input { width: 70%; padding: 10px; font-size: 16px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        #status { margin-top: 10px; color: blue; font-weight: bold; }
        .output-container { margin-top: 20px; background: #f4f4f4; padding: 15px; border-radius: 5px; }
        .emoji-result { margin: 5px 0; font-size: 1.2em; }
    </style>
    
    <script src="./emoji.js"></script>
    <script src="./emoji_search_js.js"></script>
    <script>
        // WASM 로드 이벤트를 처리할 Module 객체를 정의합니다.
        window.Module = {
            onRuntimeInitialized: function() {
                // WASM이 완전히 로드된 후 실행됩니다. (3/3 단계)
                document.getElementById('status').innerText = "3/3. WASM 모듈 로딩 완료.";
                
                window.WASM_Module = window.Module;
                
                // C++ 함수 래핑
                const searchEmojisWASM = window.WASM_Module.cwrap('search_emojis', 'number', ['number']);
                const freeResultMemoryWASM = window.WASM_Module.cwrap('free_result_memory', null, ['number']);
                
                if (window.checkReady) window.checkReady();

                // --- 검색 실행 클릭 이벤트 리스너 ---
                document.getElementById('runBtn').addEventListener('click', async () => {
                    const text = document.getElementById('userInput').value.trim();
                    if (!text || !window.extractor) return;

                    // 초기화
                    document.getElementById('status').innerText = "1/3. 텍스트를 임베딩 벡터로 변환 중...";
                    const output1Div = document.getElementById('output1');
                    const output2Div = document.getElementById('output2');
                    output1Div.innerHTML = "계산 중...";
                    output2Div.innerHTML = "대기 중...";

                    const t0 = performance.now();
                    const output = await window.extractor(text, { pooling: 'mean', normalize: true });
                    const vector = Array.from(output.data);
                    const t1 = performance.now();
                    const embeddingTime = t1 - t0;
                    document.getElementById('embeddingTime').innerText = `(공통) 텍스트 임베딩 시간: ${embeddingTime.toFixed(2)} ms`;

                    // --- 1. WASM 실행 및 결과 표시 ---
                    document.getElementById('status').innerText = "2/3. WASM으로 유사도 계산 중...";
                    let wasmPtr = 0;
                    let resultPtr = 0;
                    try {
                        wasmPtr = window.WASM_Module._malloc(vector.length * 8);
                        for (let i = 0; i < vector.length; i++) {
                            window.WASM_Module.setValue(wasmPtr + i * 8, vector[i], 'double');
                        }

                        const t2 = performance.now();
                        resultPtr = searchEmojisWASM(wasmPtr);
                        const t3 = performance.now();
                        const wasmCallTime = t3 - t2;

                        const resultJsonString = window.WASM_Module.UTF8ToString(resultPtr);
                        const resultData = JSON.parse(resultJsonString);
                        const wasmResults = resultData.results || resultData;
                        
                        let htmlOutput1 = `
                            <div style="font-size: 0.9em; color: #333;">
                                • WASM 계산 시간: <b>${wasmCallTime.toFixed(2)} ms</b>
                            </div><hr>`;
                        htmlOutput1 += formatResults(wasmResults);
                        output1Div.innerHTML = htmlOutput1;

                    } catch (error) {
                        console.error("WASM 실행 오류:", error);
                        output1Div.innerHTML = `<div style="color:red;">WASM 실행 오류: ${error.message}</div>`;
                    } finally {
                        if (wasmPtr) window.WASM_Module._free(wasmPtr);
                        if (resultPtr) freeResultMemoryWASM(resultPtr);
                    }

                    // --- 2. JavaScript 실행 및 결과 표시 ---
                    document.getElementById('status').innerText = "3/3. JavaScript로 유사도 계산 중...";
                    output2Div.innerHTML = "계산 중...";

                    const t4 = performance.now();
                    const jsResults = searchEmojisJS(vector);
                    const t5 = performance.now();
                    const jsCallTime = t5 - t4;

                    let htmlOutput2 = `
                        <div style="font-size: 0.9em; color: #333;">
                            • 순수 JS 계산 시간: <b>${jsCallTime.toFixed(2)} ms</b>
                        </div><hr>`;
                    htmlOutput2 += formatResults(jsResults);
                    output2Div.innerHTML = htmlOutput2;
                    
                    document.getElementById('status').innerText = "비교 완료!";
                });
            }
        };

        function formatResults(results) {
            if (!results || results.length === 0) return "결과 없음";
            return results.map((item, index) => {
                const meta = window.emojiMetadata[item.index];
                if (meta) {
                    return `<div class="emoji-result">
                        ${index + 1}. ${meta.character} ${meta.description} 
                        <span style="color: #666;">[Score: ${item.score.toFixed(4)}]</span>
                    </div>`;
                }
                return '';
            }).join('');
        }
    </script>
    
    <script src="./emoji_search.js"></script> 
</head>
<body>
    <h2>WASM vs JavaScript 이모지 검색 성능 비교</h2>
    <p>동일한 텍스트 임베딩</p>

    <div>
        <input type="text" id="userInput" placeholder="비교할 문장을 입력하세요...">
        <button id="runBtn" disabled>성능 비교 실행</button>
    </div>

    <div id="status">초기화 시작: 데이터 로딩 (1/3), 모델 로딩 (2/3)</div>
    <div id="embeddingTime" style="margin-top: 10px; font-size: 0.9em; color: green;"></div>

    <div style="display: flex; gap: 20px; margin-top: 20px;">
        <div style="flex: 1;">
            <h4>WASM 계산 결과</h4>
            <div id="output1" class="output-container">결과가 여기에 표시됩니다.</div>
        </div>
        <div style="flex: 1;">
            <h4>JavaScript 계산 결과</h4>
            <div id="output2" class="output-container">결과가 여기에 표시됩니다.</div>
        </div>
    </div>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.14.0';
        env.allowLocalModels = false; 

        // 전역 상태 변수 설정
        window.emojiMetadata = [];
        window.extractor = null;
        window.EMBEDDINGS = EMBEDDINGS;

        const statusDiv = document.getElementById('status');
        const runBtn = document.getElementById('runBtn');
        const CSV_FILE_PATH = './emoji.csv';

        // --- 모든 준비 완료 확인 함수 ---
        window.checkReady = function() {
            if (window.extractor && window.WASM_Module && window.emojiMetadata.length > 0 && window.EMBEDDINGS && window.EMBEDDINGS.length > 0) {
                statusDiv.innerText = `모든 모듈 로딩 완료! 이모지 ${window.emojiMetadata.length}개 검색 준비 완료.`;
                statusDiv.style.color = "green";
                runBtn.disabled = false;
            }
        }

        // --- CSV 로드 함수 (메타데이터용) ---
        async function loadEmojiMetadata(filepath) {
            try {
                const response = await fetch(filepath);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const csvText = await response.text();
                
                const lines = csvText.trim().split('\n');
                const data = lines.map(line => {
                    const parts = line.match(/(?:[^\s,"]+|"(?:\\.|[^"])*")+/g);
                    if (!parts || parts.length < 2) return null;
                    const character = parts[0].trim();
                    const description = parts[1].replace(/"/g, '').trim();
                    return { character, description };
                }).filter(item => item !== null);
                
                window.emojiMetadata = data;
                statusDiv.innerText = `1/3. 메타데이터 로드 완료 (${data.length}개).`;
            } catch (err) {
                statusDiv.innerText = `오류 발생 (1/3): CSV 로드 실패. (${err.message})`;
                statusDiv.style.color = "red";
                throw err;
            }
        }

        // --- Transformers.js 모델 로드 ---
        async function loadTransformerModel() {
            try {
                window.extractor = await pipeline('feature-extraction', 'Xenova/all-mpnet-base-v2');
                statusDiv.innerText = "2/3. 임베딩 모델 로딩 완료.";
            } catch (err) {
                statusDiv.innerText = `오류 발생 (2/3): Transformers 모델 로드 실패. (${err.message})`;
                statusDiv.style.color = "red";
                throw err;
            }
        }

        // --- 초기 로딩 시작 ---
        (async () => {
            try {
                statusDiv.innerText = "1/3. 이모지 메타데이터 로드 중...";
                await loadEmojiMetadata(CSV_FILE_PATH);

                statusDiv.innerText = "2/3. 임베딩 모델 로딩 중...";
                await loadTransformerModel();
                
                // WASM 모듈은 별도로 로드되므로, 로드 완료 시 checkReady가 호출될 때까지 기다립니다.
                // onRuntimeInitialized에서 3/3 메시지를 설정합니다.
                window.checkReady();
            } catch (err) {
                // 각 로드 함수에서 오류를 처리하므로 여기서는 별도 처리가 필요 없습니다.
                console.error("초기 로딩 중 오류 발생:", err);
            }
        })();
    </script>
</html>